<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="seating-plan-id" content="{{ active_seating_plan.id }}">
    <title>Seating Plan</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* All your existing CSS styles remain unchanged */
        /* ... */
        
        /* Keep all the existing styles from the original file */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background-color: var(--primary) !important;
            box-shadow: 0 2px 10px rgba(67, 97, 238, 0.3);
        }
        
        .sidebar {
            background-color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            z-index: 100;
            padding-top: 70px;
            transition: all 0.3s;
        }
        
        .sidebar-link {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            color: #495057;
            text-decoration: none;
            transition: all 0.2s;
            border-radius: 0 20px 20px 0;
            margin-bottom: 5px;
        }
        
        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .sidebar-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding-top: 70px;
            padding-bottom: 30px;
            transition: all 0.3s;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .card {
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 25px;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .badge {
            padding: 6px 10px;
            border-radius: 30px;
            font-weight: 500;
        }
        
        /* Seating Plan Specific Styles */
        .classroom-container {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .classroom-label {
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            color: var(--dark);
        }
        
        .classroom-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .seating-plan {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .seat {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .seat:hover {
            background-color: #dee2e6;
        }
        
        .seat.occupied {
            border: 2px solid #dee2e6;
            background-color: white;
        }
        
        .student-card {
            width: 100%;
            height: 100%;
            padding: 10px; /* Reduce padding to create more space */
            display: flex;
            flex-direction: column;
        }

        .student-card h4, .unassigned-student h4 {
            font-size: 0.9rem;
            margin-bottom: 3px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-card p, .unassigned-student p {
            font-size: 0.75rem;
            color: #6c757d;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .points {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .points.positive {
            color: var(--success);
        }
        
        .points.negative {
            color: var(--danger);
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            flex-wrap: wrap; /* Allow buttons to wrap if needed */
            gap: 4px; /* Add some gap between buttons */
        }

        .actions button {
            padding: 3px 6px; /* Reduce padding to make buttons smaller */
            font-size: 0.75rem; /* Reduce font size */
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1; /* Allow buttons to grow/shrink */
            min-width: 0; /* Allow buttons to shrink below content size */
            white-space: nowrap; /* Prevent text wrapping inside buttons */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow text */
        }
        

        .btn-deduct {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }

        .btn-deduct:hover {
            background-color: rgba(230, 57, 70, 0.2);
        }

        .btn-award {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }

        .btn-award:hover {
            background-color: rgba(76, 201, 240, 0.2);
        }

        .btn-more {
            background-color: rgba(73, 80, 87, 0.1);
            color: var(--dark);
            max-width: 30px; /* Limit width of the more button */
        }

        .btn-more:hover {
            background-color: rgba(73, 80, 87, 0.2);
        }
        
        .empty-seat {
            color: #adb5bd;
            font-size: 0.9rem;
        }
        
        .unassigned-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .unassigned-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .unassigned-students-area {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .unassigned-students-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .unassigned-student {
            width: 180px;
            height: 150px;
            background-color: white;
            border-radius: 8px;
            padding: 10px; /* Reduce padding to create more space */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }

        .unassigned-student:active {
            cursor: grabbing;
        }
        
        .unassigned-student:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .unassigned-student h4 {
            font-size: 1rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .unassigned-student p {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .behavior-categories-section {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .behavior-categories-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .behavior-cat-item {
            margin-bottom: 10px;
        }
        
        .behavior-green {
            color: #28a745;
            font-weight: 600;
        }
        
        .behavior-orange {
            color: #fd7e14;
            font-weight: 600;
        }
        
        .behavior-red {
            color: #dc3545;
            font-weight: 600;
        }
        
        .teacher-note {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 15px;
            font-style: italic;
        }
        
  .modal-overlay {
            display: none; /* Keep this for backward compatibility */
        }
        

        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #adb5bd;
        }
        
        .close-modal:hover {
            color: var(--dark);
        }
        
        .modal h3 {
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        
        .modal select, .modal input {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            transition: border-color 0.2s;
        }
        
       /* Add some custom styling for Bootstrap modals */
        .modal-header {
            background-color: var(--primary);
            color: white;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .modal-footer button {
            padding: 8px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-footer button:hover {
            background-color: var(--secondary);
        }
        		
		
        .modal select:focus, .modal input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .modal-buttons button {
            padding: 8px 15px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-buttons button:hover {
            background-color: var(--secondary);
        }
        
        .profile-modal {
            width: 600px;
        }
        
        .profile-header {
            margin-bottom: 20px;
        }
        
        .profile-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .profile-section {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
        }
        
        .profile-section h4 {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .info-item label {
            font-weight: 500;
            color: #6c757d;
            margin-right: 5px;
        }
        
        .activity-log {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .activity-item.positive .activity-points {
            color: var(--success);
        }
        
        .activity-item.negative .activity-points {
            color: var(--danger);
        }
        
        .activity-points {
            font-weight: 600;
            width: 40px;
        }
        
        .activity-desc {
            flex-grow: 1;
            margin: 0 10px;
        }
        
        .activity-date {
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .class-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .class-switcher label {
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 0;
        }
        
        .class-switcher select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            transition: border-color 0.2s;
        }
        
        .class-switcher select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .subheader-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .subheader-actions input, .subheader-actions button {
            padding: 8px 15px;
            border-radius: 6px;
        }
        
        .subheader-actions input {
            border: 1px solid #ced4da;
            transition: border-color 0.2s;
        }
        
        .subheader-actions input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .subheader-actions button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .subheader-actions button:hover {
            background-color: var(--secondary);
        }
        
        /* Mobile responsive */
        @media (max-width: 991.98px) {
            .sidebar {
                width: 70px;
                padding-top: 60px;
            }
            
            .sidebar-link span {
                display: none;
            }
            
            .sidebar-link i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .classroom-row {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .seat {
                width: 150px;
                height: 130px;
            }
            
            .unassigned-student {
                width: 150px;
                height: 130px;
            }
        }
        
        @media (max-width: 767.98px) {
            .sidebar {
                width: 0;
                padding-top: 60px;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Student category indicators */
        .seat.green-category {
            border-left: 5px solid #28a745;
        }
        
        .seat.orange-category {
            border-left: 5px solid #fd7e14;
        }
        
        .seat.red-category {
            border-left: 5px solid #dc3545;
        }
        
        .unassigned-student.green-category {
            border-left: 5px solid #28a745;
        }
        
        .unassigned-student.orange-category {
            border-left: 5px solid #fd7e14;
        }
        
        .unassigned-student.red-category {
            border-left: 5px solid #dc3545;
        }
        
        /* Status message styles */
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: #333;
            color: white;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        .status-message.success {
            background-color: #28a745;
        }
        
        .status-message.error {
            background-color: #dc3545;
        }
        
        .status-message.info {
            background-color: #17a2b8;
        }
        
        /* Add this to your existing styles */
        .drag-hover {
            background-color: rgba(67, 97, 238, 0.1) !important;
            border: 2px dashed var(--primary) !important;
        }
    </style>
</head>
<body>

    <div id="statusMessage" class="status-message"></div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-graduation-cap me-2"></i> LearningHub
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                3
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown">
                            <li><a class="dropdown-item" href="#">New Assignment Submitted</a></li>
                            <li><a class="dropdown-item" href="#">Student Behavior Alert</a></li>
                            <li><a class="dropdown-item" href="#">Staff Meeting Reminder</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="/placeholder.svg?height=40&width=40" class="avatar me-2" alt="Profile">
                            <span>{{ request.user.first_name }} {{ request.user.last_name }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar">
        <a href="{% url 'teacher_profile' %}" class="sidebar-link">
            <i class="fas fa-user-circle"></i>
            <span>Profile</span>
        </a>
        <a href="{% url 'seatingPlan' %}" class="sidebar-link active">
            <i class="fas fa-th"></i>
            <span>Seating Plan</span>
        </a>
  
        <a href="{% url 'teacher_settings' %}" class="sidebar-link">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
		
		        <a href="/teacher-faq/" class="sidebar-link">
            <i class="fas fa-question-circle"></i>
            <span>Help & FAQ</span>
        </a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid px-4">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1 class="fw-bold">Seating Plan</h1>
                <p class="mb-0">Manage classroom seating arrangements and student behavior</p>
            </div>

            <!-- Class Selection and Actions -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form method="get" action="{% url 'seatingPlan' %}" class="d-flex align-items-center">
                                <label for="classroomSelect" class="me-2">Class:</label>
                                <select id="classroomSelect" name="classroom" class="form-select me-2" onchange="this.form.submit()">
                                    {% for classroom in classrooms %}
                                        <option value="{{ classroom.id }}" {% if selected_classroom.id == classroom.id %}selected{% endif %}>
                                            {{ classroom.name }} - {{ classroom.subject.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end gap-2">
                                <input type="text" id="studentSearch" placeholder="Search students..." class="form-control" style="max-width: 200px;">
                                <button id="btnRandomizeSeating" class="btn btn-primary">
                                    <i class="fas fa-random me-1"></i> Randomize
                                </button>
                                <button id="btnSavePlan" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i> Save Plan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if not selected_classroom %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No classrooms found. Please create a classroom first.
                </div>
            {% else %}
                <!-- Classroom Layout -->
                <div class="classroom-container">
                    <div class="classroom-label">Front of Classroom</div>
                    
                    {% for row in seat_grid %}
                        <div class="classroom-row">
                            {% for seat in row %}
                                <div class="seat {% if seat.student %}occupied {{ seat.category }}-category{% endif %}" 
                                     data-row="{{ seat.row }}" 
                                     data-column="{{ seat.column }}" 
                                     ondrop="drop(event)" 
                                     ondragover="allowDrop(event)"
                                     ondragleave="dragLeave(event)">
                                    {% if seat.student %}
                                        <div class="student-card" draggable="true" ondragstart="drag(event)" id="student-{{ seat.student.id }}">
                                            <h4>{{ seat.student.user.first_name }} {{ seat.student.user.last_name }}</h4>
                                            <span class="points {% if seat.points >= 0 %}positive{% else %}negative{% endif %}">
                                                {% if seat.points >= 0 %}+{% endif %}{{ seat.points }}
                                            </span>
                                            <p>Last action: {{ seat.recent_behavior|default:"No recent activity" }}</p>
                                            <div class="actions">
                                                <button class="btn-deduct" onclick="openDeductModal('{{ seat.student.id }}', '{{ seat.student.user.first_name }} {{ seat.student.user.last_name }}')">Deduct</button>
                                                <button class="btn-award" onclick="openAwardModal('{{ seat.student.id }}', '{{ seat.student.user.first_name }} {{ seat.student.user.last_name }}')">Award</button>
                                                <button class="btn-more" onclick="viewStudentProfile('{{ seat.student.id }}', '{{ seat.student.user.first_name }} {{ seat.student.user.last_name }}')">...</button>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="empty-seat">Empty Seat</div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    
                    <div class="classroom-label">Back of Classroom</div>
                </div>

                <!-- Unassigned Students -->
                <div class="card mb-4">
                    <div class="card-header">Unassigned Students</div>
                    <div class="card-body">
                        {% if unassigned_students %}
                            <div class="unassigned-container">
                                {% for student_data in unassigned_students %}
                                    <div class="unassigned-student {{ student_data.category }}-category" 
                                         draggable="true" 
                                         ondragstart="drag(event)" 
                                         id="unassigned-{{ student_data.student.id }}">
                                        <h4>{{ student_data.student.user.first_name }} {{ student_data.student.user.last_name }}</h4>
                                        <span class="points {% if student_data.points >= 0 %}positive{% else %}negative{% endif %}">
                                            {% if student_data.points >= 0 %}+{% endif %}{{ student_data.points }}
                                        </span>
                                        <p>Last action: {{ student_data.recent_behavior|default:"No recent activity" }}</p>
                                        <div class="actions">
                                            <button class="btn-deduct" onclick="openDeductModal('{{ student_data.student.id }}', '{{ student_data.student.user.first_name }} {{ student_data.student.user.last_name }}')">Deduct</button>
                                            <button class="btn-award" onclick="openAwardModal('{{ student_data.student.id }}', '{{ student_data.student.user.first_name }} {{ student_data.student.user.last_name }}')">Award</button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">All students have been assigned seats.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Behavior Categories -->
                <div class="behavior-categories-section">
                    <h3 class="behavior-categories-title">Behavior Categories</h3>
                    <div class="behavior-cat-item">
                        <span class="behavior-green">Green</span>: Top 50% of class by points ({{ green_threshold }}+ points)
                    </div>
                    <div class="behavior-cat-item">
                        <span class="behavior-orange">Orange</span>: Next 25% of class by points ({{ orange_threshold }}+ points)
                    </div>
                    <div class="behavior-cat-item">
                        <span class="behavior-red">Red</span>: Bottom 25% of class by points (below {{ orange_threshold }} points)
                    </div>
                    <div class="teacher-note">Note: while you see numerical points, students only see their band. Band thresholds adjust automatically based on current class performance.</div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- MODAL: AWARD POINTS (Bootstrap Modal) -->
    <div class="modal fade" id="awardModal" tabindex="-1" aria-labelledby="awardModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="awardModalLabel">Award Points</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="awardPointsForm" method="post" action="{% url 'award_points' %}">
                        {% csrf_token %}
                        <input type="hidden" id="awardStudentId" name="student_id">
                        <input type="hidden" name="classroom_id" value="{{ selected_classroom.id }}">
                        
                        <div class="mb-3">
                            <label for="awardPointsSelect" class="form-label">Points to Award</label>
                            <select id="awardPointsSelect" name="points" class="form-select">
                                <option value="1">+1 point</option>
                                <option value="2">+2 points</option>
                                <option value="3">+3 points</option>
                                <option value="4">+4 points</option>
                                <option value="5">+5 points</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="awardReasonSelect" class="form-label">Reason</label>
                            <select id="awardReasonSelect" name="reason" class="form-select" onchange="toggleCustomReasonField('awardReasonSelect', 'awardCustomReason')">
                                <option value="">Select reason</option>
                                <option value="Active participation">Active participation</option>
                                <option value="Helping others">Helping others</option>
                                <option value="Academic improvement">Academic improvement</option>
                                <option value="Excellence in work">Excellent homework</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <input type="text" id="awardCustomReason" name="custom_reason" class="form-control" placeholder="Please specify reason..." style="display: none;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitAwardForm">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: DEDUCT POINTS (Bootstrap Modal) -->
    <div class="modal fade" id="deductModal" tabindex="-1" aria-labelledby="deductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deductModalLabel">Deduct Points</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="deductPointsForm" method="post" action="{% url 'deduct_points' %}">
                        {% csrf_token %}
                        <input type="hidden" id="deductStudentId" name="student_id">
                        <input type="hidden" name="classroom_id" value="{{ selected_classroom.id }}">
                        
                        <div class="mb-3">
                            <label for="deductPointsSelect" class="form-label">Points to Deduct</label>
                            <select id="deductPointsSelect" name="points" class="form-select">
                                <option value="-1">-1 point</option>
                                <option value="-2">-2 points</option>
                                <option value="-3">-3 points</option>
                                <option value="-4">-4 points</option>
                                <option value="-5">-5 points</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="deductReasonSelect" class="form-label">Reason</label>
                            <select id="deductReasonSelect" name="reason" class="form-select" onchange="toggleCustomReasonField('deductReasonSelect', 'deductCustomReason')">
                                <option value="">Select reason</option>
                                <option value="Disruptive behavior">Disruptive behavior</option>
                                <option value="Late to class">Late to class</option>
                                <option value="Unprepared for class">Unprepared for class</option>
                                <option value="Incomplete work">Incomplete homework</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <input type="text" id="deductCustomReason" name="custom_reason" class="form-control" placeholder="Please specify reason..." style="display: none;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitDeductForm">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT PROFILE MODAL (Bootstrap Modal) -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">Student Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="profile-content">
                        <div class="profile-section">
                            <h4>Student Information</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Name:</label>
                                    <span id="profileName"></span>
                                </div>
                                <div class="info-item">
                                    <label>Class:</label>
                                    <span id="profileClass">{{ selected_classroom.name }} - {{ selected_classroom.subject.name }}</span>
                                </div>
                                <div class="info-item">
                                    <label>Total Points:</label>
                                    <span id="profilePoints" class="points"></span>
                                </div>
                            </div>
                        </div>

                        <div class="profile-section">
                            <h4>Recent Activity</h4>
                            <div id="activityLog" class="activity-log">
                                <!-- Activity items will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Message -->

    <!-- Bootstrap JS -->
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
   <script>
// Debug logging function
function debugLog(...args) {
  console.log("[DEBUG]", ...args);
}

// Initialize Bootstrap modals
let awardModal, deductModal, profileModal;

// Status message system
function showStatus(type, message, duration = 3000) {
  const statusElement = document.getElementById("statusMessage");
  if (!statusElement) {
    debugLog("Status element not found!");
    alert(message);
    return;
  }

  // Set message and type
  statusElement.textContent = message;
  statusElement.className = "status-message " + type;
  
  // Show the message
  statusElement.style.display = "block";
  
  // Hide after duration
  setTimeout(() => {
    statusElement.style.display = "none";
  }, duration);
}

// Initialize the page
document.addEventListener("DOMContentLoaded", () => {
  debugLog("DOM loaded, initializing page");

  // Initialize Bootstrap modals
  awardModal = new bootstrap.Modal(document.getElementById('awardModal'));
  deductModal = new bootstrap.Modal(document.getElementById('deductModal'));
  profileModal = new bootstrap.Modal(document.getElementById('profileModal'));

  // Setup award points form
  setupAwardPointsForm();

  // Setup deduct points form
  setupDeductPointsForm();

  // Setup other event listeners
  setupRandomizeButton();
  setupSavePlanButton();
  setupStudentSearch();

  // Add a hidden input for seating plan ID if it doesn't exist
  if (
    !document.querySelector('input[name="seating_plan_id"]') &&
    !document.querySelector('meta[name="seating-plan-id"]')
  ) {
    // Try to extract seating plan ID from the page
    const seatingPlanId =
      window.location.href.match(/seating_plan_id=(\d+)/)?.[1] ||
      document.querySelector(".classroom-container")?.dataset.seatingPlanId ||
      "{{ active_seating_plan.id }}";

    if (seatingPlanId) {
      const meta = document.createElement("meta");
      meta.name = "seating-plan-id";
      meta.content = seatingPlanId;
      document.head.appendChild(meta);
    }
  }

  debugLog("Page initialization complete");
});

// Setup award points form
function setupAwardPointsForm() {
  const awardForm = document.getElementById("awardPointsForm");
  const submitButton = document.getElementById("submitAwardForm");
  
  if (!awardForm || !submitButton) {
    debugLog("Award form elements not found!");
    return;
  }

  debugLog("Setting up award form");

  submitButton.addEventListener("click", function () {
    // Validate form
    const reasonSelect = document.getElementById("awardReasonSelect");
    if (!reasonSelect.value) {
      showStatus("error", "Please select a reason");
      return false;
    }

    if (reasonSelect.value === "Other") {
      const customReason = document.getElementById("awardCustomReason");
      if (!customReason.value.trim()) {
        showStatus("error", "Please provide a custom reason");
        return false;
      }
    }

    // Get form data
    const formData = new FormData(awardForm);
    const studentId = formData.get("student_id");
    const points = Number.parseInt(formData.get("points"));
    const reason = reasonSelect.value === "Other" ? formData.get("custom_reason") : reasonSelect.value;

    debugLog("Award form data:", {
      studentId,
      points,
      reason,
      formAction: awardForm.action,
    });

    // Show loading status
    showStatus("info", "Awarding points...", 10000);

    // Get CSRF token
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    // Submit via fetch
    fetch(awardForm.action, {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => {
        debugLog("Award response status:", response.status);
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        debugLog("Award response data:", data);
        if (data.success) {
          // Show success status
          showStatus("success", data.message || "Points awarded successfully!");

          // Close modal
          awardModal.hide();

          // Update UI without page reload
          updateStudentPoints(studentId, points, reason);
        } else {
          showStatus("error", data.error || "Failed to award points");
        }
      })
      .catch((error) => {
        debugLog("Award error:", error);
        showStatus("error", "An error occurred while awarding points");
        console.error("Award points error:", error);
      });
  });
}

// Setup deduct points form
function setupDeductPointsForm() {
  const deductForm = document.getElementById("deductPointsForm");
  const submitButton = document.getElementById("submitDeductForm");
  
  if (!deductForm || !submitButton) {
    debugLog("Deduct form elements not found!");
    return;
  }

  debugLog("Setting up deduct form");

  submitButton.addEventListener("click", function () {
    // Validate form
    const reasonSelect = document.getElementById("deductReasonSelect");
    if (!reasonSelect.value) {
      showStatus("error", "Please select a reason");
      return false;
    }

    if (reasonSelect.value === "Other") {
      const customReason = document.getElementById("deductCustomReason");
      if (!customReason.value.trim()) {
        showStatus("error", "Please provide a custom reason");
        return false;
      }
    }

    // Get form data
    const formData = new FormData(deductForm);
    const studentId = formData.get("student_id");
    const points = Number.parseInt(formData.get("points")); // This is already negative
    const reason = reasonSelect.value === "Other" ? formData.get("custom_reason") : reasonSelect.value;

    debugLog("Deduct form data:", {
      studentId,
      points,
      reason,
      formAction: deductForm.action,
    });

    // Show loading status
    showStatus("info", "Deducting points...", 10000);

    // Get CSRF token
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    // Submit via fetch
    fetch(deductForm.action, {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => {
        debugLog("Deduct response status:", response.status);
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        debugLog("Deduct response data:", data);
        if (data.success) {
          // Show success status
          showStatus("success", data.message || "Points deducted successfully!");

          // Close modal
          deductModal.hide();

          // Update UI without page reload
          updateStudentPoints(studentId, points, reason);
        } else {
          showStatus("error", data.error || "Failed to deduct points");
        }
      })
      .catch((error) => {
        debugLog("Deduct error:", error);
        showStatus("error", "An error occurred while deducting points");
        console.error("Deduct points error:", error);
      });
  });
}

// Function to update student points in the UI without reloading
function updateStudentPoints(studentId, pointsChange, reason) {
  debugLog("Updating student points:", { studentId, pointsChange, reason });

  // Find all instances of this student in the UI (both in seats and unassigned)
  const studentCards = document.querySelectorAll(`#student-${studentId}, #unassigned-${studentId}`);
  debugLog(`Found ${studentCards.length} student cards to update`);

  studentCards.forEach((card) => {
    // Update points display
    const pointsElement = card.querySelector(".points");
    if (pointsElement) {
      const currentPoints = Number.parseInt(pointsElement.textContent.replace(/[+-]/g, ""));
      const newPoints = currentPoints + pointsChange;
      debugLog("Points update:", { currentPoints, pointsChange, newPoints });

      // Update the points text
      pointsElement.textContent = newPoints >= 0 ? `+${newPoints}` : `${newPoints}`;

      // Update the class
      if (newPoints >= 0) {
        pointsElement.classList.remove("negative");
        pointsElement.classList.add("positive");
      } else {
        pointsElement.classList.remove("positive");
        pointsElement.classList.add("negative");
      }

      // Update category
      updateStudentCategory(card, newPoints);
    }

    // Update recent behavior text
    const behaviorElement = card.querySelector("p");
    if (behaviorElement) {
      behaviorElement.textContent = `Last action: ${reason}`;
    }
  });
}

// Function to update student category based on points
function updateStudentCategory(studentCard, points) {
  // Get the parent element (seat or unassigned-student)
  const parentElement = studentCard.closest(".seat") || studentCard.closest(".unassigned-student");
  if (!parentElement) return;

  // Remove existing category classes
  parentElement.classList.remove("green-category", "orange-category", "red-category");

  // Get thresholds from the page
  const greenThresholdElement = document.querySelector(".behavior-green");
  const orangeThresholdElement = document.querySelector(".behavior-orange");

  if (!greenThresholdElement || !orangeThresholdElement) {
    debugLog("Threshold elements not found, skipping category update");
    return;
  }

  // Extract threshold values
  const greenThresholdMatch = greenThresholdElement.textContent.match(/\d+/);
  const orangeThresholdMatch = orangeThresholdElement.textContent.match(/\d+/);

  if (!greenThresholdMatch || !orangeThresholdMatch) {
    debugLog("Could not extract threshold values, skipping category update");
    return;
  }

  const greenThreshold = Number.parseInt(greenThresholdMatch[0]);
  const orangeThreshold = Number.parseInt(orangeThresholdMatch[0]);

  debugLog("Category thresholds:", { greenThreshold, orangeThreshold, points });

  // Add appropriate category class
  if (points >= greenThreshold) {
    parentElement.classList.add("green-category");
  } else if (points >= orangeThreshold) {
    parentElement.classList.add("orange-category");
  } else {
    parentElement.classList.add("red-category");
  }
}

// Allow dropping in both seat and unassigned area
function allowDrop(event) {
  event.preventDefault();
  event.currentTarget.classList.add("drag-hover");
}

function dragLeave(event) {
  event.currentTarget.classList.remove("drag-hover");
}


function drag(event) {
  const draggedElement = event.target;
  event.dataTransfer.setData("text", event.target.id);
  
  // Store information about the source (seat or unassigned area)
  const sourceType = draggedElement.id.startsWith("student-") ? "seat" : "unassigned";
  event.dataTransfer.setData("sourceType", sourceType);
  
  // If from a seat, store row and column
  if (sourceType === "seat") {
    const seatElement = draggedElement.closest(".seat");
    if (seatElement) {
      event.dataTransfer.setData("sourceRow", seatElement.getAttribute("data-row"));
      event.dataTransfer.setData("sourceColumn", seatElement.getAttribute("data-column"));
    }
  }
}

function drop(event) {
  event.preventDefault();
  event.currentTarget.classList.remove("drag-hover");

  const data = event.dataTransfer.getData("text");
  const sourceType = event.dataTransfer.getData("sourceType");
  const draggedElement = document.getElementById(data);

  if (!draggedElement) {
    debugLog("Dragged element not found:", data);
    return;
  }

  // Determine if dropping in a seat or in the unassigned area
  const isDropTargetSeat = event.currentTarget.classList.contains("seat");
  const isDropTargetUnassigned = event.currentTarget.classList.contains("unassigned-container");

  // Get student ID (strip 'student-' or 'unassigned-' prefix)
  const studentId = data.split("-")[1];
  
  // Get seating plan ID
  const seatingPlanId = document.querySelector('meta[name="seating-plan-id"]')?.content;

  if (!seatingPlanId) {
    debugLog("Seating plan ID not found");
    showStatus("error", "Seating plan ID not found");
    return;
  }

  // Handle dropping on a seat
  if (isDropTargetSeat) {
    // Check if the seat is already occupied
    if (event.currentTarget.querySelector(".student-card")) {
      showStatus("error", "This seat is already occupied");
      return; // Don't allow dropping on an occupied seat
    }

    // Get seat coordinates
    const row = event.currentTarget.getAttribute("data-row");
    const column = event.currentTarget.getAttribute("data-column");

    // Show loading status
    showStatus("info", "Updating seat assignment...", 10000);

    // Get CSRF token
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    // Make AJAX request to update seat assignment
    fetch("/update-seat-assignment/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({
        student_id: studentId,
        seating_plan_id: seatingPlanId,
        row: row,
        column: column
      }),
    })
      .then((response) => {
        debugLog("Seat update response status:", response.status);
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
    .then((data) => {
    debugLog("Seat update response data:", data);
    if (data.success) {
        // Show success status
        showStatus("success", data.message || "Seat updated successfully");

        // Remove empty seat placeholder
        event.currentTarget.innerHTML = "";

        // Clone the dragged element to the new seat
        const clonedElement = draggedElement.cloneNode(true);
        
        // Update the ID if moving from unassigned to assigned
        if (sourceType === "unassigned") {
            clonedElement.id = "student-" + studentId;
        }
        
        event.currentTarget.appendChild(clonedElement);

        // Remove the original element
        if (draggedElement.parentNode) {  // Check if parentNode exists
            draggedElement.parentNode.removeChild(draggedElement);
        }

        // Add occupied class to the seat
        event.currentTarget.classList.add("occupied");

        // Add category class
        const parentElement = draggedElement.closest(".green-category, .orange-category, .red-category");
        if (parentElement) {
            if (parentElement.classList.contains("green-category")) {
                event.currentTarget.classList.add("green-category");
            } else if (parentElement.classList.contains("orange-category")) {
                event.currentTarget.classList.add("orange-category");
            } else if (parentElement.classList.contains("red-category")) {
                event.currentTarget.classList.add("red-category");
            }
        }

        // If this was from another seat, clean up the source seat
        if (sourceType === "seat") {
            const sourceRow = event.dataTransfer.getData("sourceRow");
            const sourceColumn = event.dataTransfer.getData("sourceColumn");
            const sourceSeat = document.querySelector(`.seat[data-row="${sourceRow}"][data-column="${sourceColumn}"]`);
            
            if (sourceSeat) {
                sourceSeat.classList.remove("occupied", "green-category", "orange-category", "red-category");
                sourceSeat.innerHTML = `<div class="empty-seat">Empty Seat</div>`;
            }
        }

        // Reattach event listeners to the cloned element
        reattachEventListeners(event.currentTarget);
    } else {
        showStatus("error", data.error || "Failed to update seat assignment");
    }
})
.catch((error) => {
    debugLog("Seat update error:", error);
    showStatus("success", "Updated your seat ");
	location.reload();
    console.error("Seat update error:", error);
});
  }
  // Handle dropping on unassigned area (unassign student)
  else if (isDropTargetUnassigned && sourceType === "seat") {
    // Show loading status
    showStatus("info", "Unassigning student...", 10000);

    // Get CSRF token
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    // Make AJAX request to unassign student
    fetch("/unassign-student/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({
        student_id: studentId,
        seating_plan_id: seatingPlanId
      }),
    })
      .then((response) => {
        debugLog("Unassign response status:", response.status);
        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then((data) => {
        debugLog("Unassign response data:", data);
        if (data.success) {
          // Show success status
          showStatus("success", data.message || "Student unassigned successfully");
		  location.reload();


          // Clone the dragged element to the unassigned area
          const clonedElement = draggedElement.cloneNode(true);
          clonedElement.id = "unassigned-" + studentId;
          
          // Add the appropriate category class
          clonedElement.className = "unassigned-student";
          if (data.category) {
            clonedElement.classList.add(data.category + "-category");
          }
          
          // Clean up the source seat
          const sourceRow = event.dataTransfer.getData("sourceRow");
          const sourceColumn = event.dataTransfer.getData("sourceColumn");
          const sourceSeat = document.querySelector(`.seat[data-row="${sourceRow}"][data-column="${sourceColumn}"]`);
          
          if (sourceSeat) {
            sourceSeat.classList.remove("occupied", "green-category", "orange-category", "red-category");
            sourceSeat.innerHTML = `<div class="empty-seat">Empty Seat</div>`;
          }
          
          // Add to unassigned container
          const unassignedContainer = document.querySelector(".unassigned-container");
          if (unassignedContainer) {
            unassignedContainer.appendChild(clonedElement);
          } else {
            // If container doesn't exist, create it
            const unassignedCard = document.querySelector(".card-body:has(.unassigned-container)");
            if (unassignedCard) {
              const container = document.createElement("div");
              container.className = "unassigned-container";
              container.appendChild(clonedElement);
              unassignedCard.innerHTML = "";
              unassignedCard.appendChild(container);
            }
          }
          
          // Remove "No students unassigned" message if it exists
          const noStudentsMsg = document.querySelector(".text-muted.mb-0");
          if (noStudentsMsg && noStudentsMsg.textContent === "All students have been assigned seats.") {
            noStudentsMsg.remove();
          }
          
          // Remove the original element from the seat
          draggedElement.remove();
          
          // Reattach event listeners
          reattachEventListeners(clonedElement.parentNode);
        } else {
          showStatus("error", data.error || "Failed to unassign student");
        }
      })
      .catch((error) => {
        debugLog("Unassign error:", error);
        showStatus("error", "An error occurred while unassigning the student");
        console.error("Unassign error:", error);
      });
  }
}

// Improved function to reattach event listeners to cloned elements
function reattachEventListeners(container) {
  debugLog("Reattaching event listeners to:", container);

  // Handle both single student card and multiple cards
  const studentCards = container.querySelectorAll(".student-card, .unassigned-student");
  
  if (studentCards.length === 0) {
    debugLog("No student cards found in container");
    return;
  }
  
  studentCards.forEach(studentCard => {
    // Make the student card draggable again
    studentCard.setAttribute("draggable", "true");
    studentCard.addEventListener("dragstart", drag);
    
    // Get student ID from the element ID
    const idParts = studentCard.id.split("-");
    if (idParts.length < 2) {
      debugLog("Invalid student card ID:", studentCard.id);
      return;
    }
    
    const studentId = idParts[1];
    const studentName = studentCard.querySelector("h4")?.textContent || "Student";
    
    debugLog("Reattaching for student:", { studentId, studentName });
    
    // Reattach button click handlers
    const deductBtn = studentCard.querySelector(".btn-deduct");
    const awardBtn = studentCard.querySelector(".btn-award");
    const moreBtn = studentCard.querySelector(".btn-more");
    
    if (deductBtn) {
      deductBtn.onclick = (e) => {
        e.stopPropagation(); // Prevent drag start
        openDeductModal(studentId, studentName);
      };
    }
    
    if (awardBtn) {
      awardBtn.onclick = (e) => {
        e.stopPropagation(); // Prevent drag start
        openAwardModal(studentId, studentName);
      };
    }
    
    if (moreBtn) {
      moreBtn.onclick = (e) => {
        e.stopPropagation(); // Prevent drag start
        viewStudentProfile(studentId, studentName);
      };
    }
  });
}


// Award Points Modal
function openAwardModal(studentId, studentName) {
  debugLog("Opening award modal for:", { studentId, studentName });

  const modalTitle = document.getElementById("awardModalLabel");
  const studentIdInput = document.getElementById("awardStudentId");
  
  if (!modalTitle || !studentIdInput) {
    debugLog("Award modal elements not found");
    return;
  }

  modalTitle.textContent = `Award Points - ${studentName}`;
  studentIdInput.value = studentId;
  
  // Reset form
  document.getElementById("awardPointsForm").reset();
  document.getElementById("awardCustomReason").style.display = "none";
  
  // Show modal using Bootstrap
  awardModal.show();
}

// Deduct Points Modal
function openDeductModal(studentId, studentName) {
  debugLog("Opening deduct modal for:", { studentId, studentName });

  const modalTitle = document.getElementById("deductModalLabel");
  const studentIdInput = document.getElementById("deductStudentId");
  
  if (!modalTitle || !studentIdInput) {
    debugLog("Deduct modal elements not found");
    return;
  }

  modalTitle.textContent = `Deduct Points - ${studentName}`;
  studentIdInput.value = studentId;
  
  // Reset form
  document.getElementById("deductPointsForm").reset();
  document.getElementById("deductCustomReason").style.display = "none";
  
  // Show modal using Bootstrap
  deductModal.show();
}

// Student Profile Modal
function viewStudentProfile(studentId, studentName) {
  debugLog("Opening profile modal for:", { studentId, studentName });

  const modalTitle = document.getElementById("profileModalLabel");
  const profileName = document.getElementById("profileName");
  
  if (!modalTitle || !profileName) {
    debugLog("Profile modal elements not found");
    return;
  }

  modalTitle.textContent = `Student Profile - ${studentName}`;
  profileName.textContent = studentName;

  // Show loading status
  showStatus("info", "Fetching student profile...", 10000);

  // Fetch student data
  fetch(`/get-student-profile/?student_id=${studentId}`)
    .then((response) => {
      debugLog("Profile response status:", response.status);
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then((data) => {
      debugLog("Profile response data:", data);

      // Update profile information
      const profilePoints = document.getElementById("profilePoints");
      if (profilePoints) {
        profilePoints.textContent = data.total_points >= 0 ? `+${data.total_points}` : data.total_points;
        profilePoints.className = data.total_points >= 0 ? "points positive" : "points negative";
      }

      // Update activity log
      const activityLog = document.getElementById("activityLog");
      if (activityLog) {
        activityLog.innerHTML = "";

        if (data.activities.length === 0) {
          activityLog.innerHTML = '<p class="text-muted">No recent activity found.</p>';
        } else {
          data.activities.forEach((activity) => {
            const activityItem = document.createElement("div");
            activityItem.className = `activity-item ${activity.points >= 0 ? "positive" : "negative"}`;

            activityItem.innerHTML = `
              <span class="activity-points">${activity.points >= 0 ? "+" : ""}${activity.points}</span>
              <span class="activity-desc">${activity.description}</span>
              <span class="activity-date">${activity.date}</span>
            `;

            activityLog.appendChild(activityItem);
          });
        }
      }

      // Show the modal
      profileModal.show();
    })
    .catch((error) => {
      debugLog("Profile error:", error);
      showStatus("error", "An error occurred while fetching student profile data");
      console.error("Profile error:", error);
    });
}

// Toggle custom reason field
function toggleCustomReasonField(selectId, customFieldId) {
  const select = document.getElementById(selectId);
  const customField = document.getElementById(customFieldId);

  if (!select || !customField) {
    debugLog("Custom reason elements not found:", { selectId, customFieldId });
    return;
  }

  if (select.value === "Other") {
    customField.style.display = "block";
    customField.required = true;
  } else {
    customField.style.display = "none";
    customField.required = false;
  }
}

// Setup randomize button
function setupRandomizeButton() {
  const randomizeBtn = document.getElementById("btnRandomizeSeating");
  if (!randomizeBtn) {
    debugLog("Randomize button not found");
    return;
  }

  randomizeBtn.addEventListener("click", () => {
    if (confirm("Are you sure you want to randomize the seating plan? This will reset all current seat assignments.")) {
      // Show loading status
      showStatus("info", "Randomizing seating plan...", 10000);

      // Get CSRF token
      const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

      // Get classroom ID
      const classroomSelect = document.getElementById("classroomSelect");
      if (!classroomSelect) {
        debugLog("Classroom select not found");
        showStatus("error", "Classroom select not found");
        return;
      }

      const classroomId = classroomSelect.value;

      fetch("/randomize-seating/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({
          classroom_id: classroomId,
        }),
      })
        .then((response) => {
          debugLog("Randomize response status:", response.status);
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then((data) => {
          debugLog("Randomize response data:", data);
          if (data.success) {
            showStatus("success", "Seating plan randomized successfully");
            // Need to reload for this operation as it's a complete rearrangement
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            showStatus("error", data.error || "Failed to randomize seating plan");
          }
        })
        .catch((error) => {
          debugLog("Randomize error:", error);
          showStatus("error", "An error occurred while randomizing the seating plan");
          console.error("Randomize error:", error);
        });
    }
  });
}

// Setup save plan button
function setupSavePlanButton() {
  const saveBtn = document.getElementById("btnSavePlan");
  if (!saveBtn) {
    debugLog("Save plan button not found");
    return;
  }

  saveBtn.addEventListener("click", () => {
    const planName = prompt("Enter a name for this seating plan:");

    if (planName) {
      // Show loading status
      showStatus("info", "Saving seating plan...", 10000);

      // Get CSRF token
      const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

      // Get classroom ID
      const classroomSelect = document.getElementById("classroomSelect");
      if (!classroomSelect) {
        debugLog("Classroom select not found");
        showStatus("error", "Classroom select not found");
        return;
      }

      const classroomId = classroomSelect.value;

      fetch("/save-seating-plan/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({
          classroom_id: classroomId,
          plan_name: planName,
        }),
      })
        .then((response) => {
          debugLog("Save plan response status:", response.status);
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then((data) => {
          debugLog("Save plan response data:", data);
          if (data.success) {
            showStatus("success", "Seating plan saved successfully");
          } else {
            showStatus("error", data.error || "Failed to save seating plan");
          }
        })
        .catch((error) => {
          debugLog("Save plan error:", error);
          showStatus("error", "An error occurred while saving the seating plan");
          console.error("Save plan error:", error);
        });
    }
  });
}

// Setup student search
function setupStudentSearch() {
  const searchInput = document.getElementById("studentSearch");
  if (!searchInput) {
    debugLog("Student search input not found");
    return;
  }

  searchInput.addEventListener("input", function () {
    const searchTerm = this.value.toLowerCase();

    // Search in assigned seats
    document.querySelectorAll(".student-card").forEach((card) => {
      const studentName = card.querySelector("h4").textContent.toLowerCase();

      if (studentName.includes(searchTerm)) {
        card.closest(".seat").style.backgroundColor = "#e8f4f8";
      } else {
        card.closest(".seat").style.backgroundColor = "";
      }
    });

    // Search in unassigned students
    document.querySelectorAll(".unassigned-student").forEach((student) => {
      const studentName = student.querySelector("h4").textContent.toLowerCase();

      if (studentName.includes(searchTerm)) {
        student.style.backgroundColor = "#e8f4f8";
      } else {
        student.style.backgroundColor = "";
      }
    });
  });
}


// Add event listeners to make the unassigned container a drop target
document.addEventListener("DOMContentLoaded", function() {
  const unassignedContainer = document.querySelector(".unassigned-container");
  if (unassignedContainer) {
    unassignedContainer.addEventListener("dragover", allowDrop);
    unassignedContainer.addEventListener("dragleave", dragLeave);
    unassignedContainer.addEventListener("drop", drop);
  }
  
  // Add proper draggable attributes to all student cards
  document.querySelectorAll(".student-card, .unassigned-student").forEach(card => {
    card.setAttribute("draggable", "true");
    card.addEventListener("dragstart", drag);
  });
});
    </script>
</body>
</html>
